# The Interaction Flow

[FLOW DIAGRAM HERE]

When a device has some configuration that the user may change, it starts to advertise its presence to surrounding Envoys. These advertisements detail the type of configuration that the device wants, and the permissions that an Envoy must have to change the configuration.

If an Envoy determines that it has the right set of permissions and the user is interested in changing the configuration of the device, it offers an appropriate interface to the user to edit the settings. Once the user is happy with the settings the Envoy saves the new configuration to the device.

# Concepts

## Intents

[IMAGE: ICON TO REPRESENT INTENTS? MAYBE REUSUABLE IN OTHER PLACES?]

An Intent encapsulates an action that a device can perform, contains the information that allows an Envoy to determine if it has the permissions to perform the action, and details any parameters the Envoy must collect to invoke the action. For example, the Intent with action com.arm.connectivity.wifi tells the device to connect to a WiFi network and has parameters for ssid and key.

A devices advertises a set of Intents that can currently be performed. Specifically, an Intent contains the following fields:

`action` - a globally namespaced identifier for the type of action, of the form `<action-id>:<version>` (e.g. `com.arm.connectivity.wifi:1`). Action identifiers are generic, so there should be one action identifier for "opening a door", and so on. 

`constraints` - (optional) a description of the parameters required for the action, including constraints on possible values, such as type, minimum value and maximum value.
Each `action` ID is associated with some standard set of constraints (and services exist for looking up such constraints), and any constraints in the Intent are in addition to this. See the API docs for full details [LINK].

`authority` - (optional) a list of possible authorities that must authorize the invocation of the action. See the API docs for authority [LINK TO API DOCS].

`endpoint` - the address at which the action can be invoked. This is a URL specifying where the parameters should be sent to make the action being advertised happen. It doesn’t necessarily have to be an address on the device that is advertising the Intent, but often will be. This is analogous to the webhook model often found in web service development.

`url` - (optional) the address at which the Intent is being advertised. This is the URL of the resource that represents the Intent.

`knownParameters` - (optional) a list of (possibly partial) parameter sets that might help the Envoy to generate a UI. You can think of these as auto-fill fields that you might find when filling in a form in a web browser. They are intended to provide the user with a fast way to fill out forms with known or pre-entered values. The Envoy may cache values provided via known parameters. 


In order to promote reuse of Intents and to reduce the size of Intents that the device must store and advertise, the Envoy will also fetch any Intent with a matching action from the [Intent registry](faqs.md#what-is-the-intent-registry) and merge the constraints of the Intent provided by the device with the Intent from the registry. Read more about the Intent registry, including how to add new Intents to the registry, [here](faqs.md#how-do-i-add-an-intent-to-the-intent-registry).

Intents are immutable once published to the registry. To make changes to a published Intent a new version with a higher version number must be created. Version numbers are a monotonically increasing integer value. 

**Example** (using JSON encoding)
```json
{
    "url": "http://example.com/intents/wifi",
    "action": "com.arm.connectivity.wifi:1",
    "endpoint": "/invocations",
    "constraints: { ... },
    "authority": [ ... ],
    "knownParameters": [
        { "ssid": "MiWiFi" },
        { "ssid": "OtherWiFi", "key":"supersecretpassword"}
    ]
}
```

## Invocations

When an Envoy wants to perform an action advertised as an Intent by a device, it generates an Invocation resource that encapsulates the parameters that the device should use for performing the action. It also provides some proof that the Envoy has permission to perform the action it’s requesting. More on the proof mechanism [here](design_principles.md#security-privacy).

The Invocation is then posted to the endpoint that was specified in the Intent (to make the action happen). An Invocation has the following properties:

`id` - a unique ID generated by the Envoy for this particular invocation of the Intent.

`action` - the action from the Intent.

`parameters` - a set of values that fulfill the constraints described by the Intent. These are the values that the device should use to perform the action.

`codaEndpoints` - a list of addresses to which the result of the action should be posted (in the form of a [Coda](concepts.md#codas)). This doesn’t necessarily have to be an address on the Envoy that created the invocation, but there are user experience downsides when you do not notify the Envoy directly about the result. This is analogous to the webhook model often found in web service development. 

**Example** (using JSON encoding)
```json
{
    "id": 982387642302386,
    "action": "com.arm.connectivity.wifi:1",
    "parameters": { ... },
    "codaEndpoints": [
        "/codas",
        "https://example.com/codas/32642378"
    ]
}
```

## Constraint Set

A device will often require parameters for performing an action: a thermostat might need to know the SSID and password for a network so it can get internet access; a lighting system might need to know how long to keep the lights on after you leave a room; a coffee machine might let you configure how much water you like in your coffee. The number of different configuration options is endless. Envoy provides a flexible system that allows you to describe what the valid set of parameters to your device looks like without having to enumerate everything.

This is captured by a set of constraints, which includes things like minimum and maximum values, data types, data format, title and description. See the constraints API documentation [LINK TO CONSTRAINTS DOCUMENTATION] for full details.

*Note: not all of the constraints need to be transmitted from the device. There is a central [repository if Intents](faqs.md#what-is-the-intent-registry) that devices should reuse and build upon.*

**Example** (using JSON encoding)
```json
{
    "type": "dictionary",
    "title": "WiFi Access",
    "description": "Connect to a WiFi network",
    "icon": "../icons/wifi.svg",
    "properties": {
        "ssid": {
            "title": "Network Name",
            "description": "The name of the network.",
            "type": "string"
        },
        "key": {
            "title": "Password",
            "description": "The password for the network.",
            "type": "string"
        }
    }
}
```


## Codas

[IMAGE: ICON TO REPRESENT CODA? MAYBE REUSUABLE IN OTHER PLACES?]

A coda generally refers to "the concluding passage of music, typically forming an addition to the basic structure". In this case Coda is the receipt of a concluding transaction. When an Envoy has posted an Invocation to a device, the device generates a Coda and sends it to the `codaEndpoints` specified by the Invocation.

The Coda can be used as a verifiable receipt that a device received and performed an Invocation. The fields of a Coda are:

`invocation` - the ID from the Invocation that the coda is responding to.

`status` - an integer status code. Similar to HTTP status codes. Valid values are 200, 400, 500 with the same meanings as for HTTP.

`more` - are there more codas for this Invocation expected later? This indicates to the Envoy that it might need to hold open a connection to a device (for example, when using BLE). 

`intents` - a set of Intents that are now being offered as a result of performing the action. Often performing an action will result in a change in the device's behaviour. For example, after an unlock Intent is invoked a door might subsequently offer a lock Intent.

**Example** (using JSON encoding)
```json
{
    "invocation": 982387642302386,
    "status": 200,
    "more": false,
    "intents": [ ... ]
}
```
